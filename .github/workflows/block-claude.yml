name: Block Claude Content

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  check-for-claude:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check Commit Authors and Messages
        run: |
          echo "Checking for 'Claude' in commit authors and messages..."
          # Check logs for the range being pushed/PR'd
          # Default to checking HEAD if no range
          RANGE="HEAD~1..HEAD"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          fi

          if git log "$RANGE" --format="%an %cn %s %b" | grep -i "Claude"; then
            echo "::error::Found 'Claude' in commit metadata!"
            exit 1
          fi

      - name: Check File Content
        run: |
          echo "Checking for 'Claude' string in codebase..."
          # Grep recursively in the current directory, excluding .git
          if grep -rzi "Claude" . --exclude-dir=.git --exclude=block-claude.yml; then
             echo "::error::Found 'Claude' in file content!"
             exit 1
          fi
          echo "No 'Claude' found. Clean."
